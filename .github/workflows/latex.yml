name: Build LaTeX from tex/

on: [push]

jobs:
  tex-build:
    runs-on: ubuntu-latest
    name: Build LaTeX
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check for tex/ changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            tex:
              - 'tex/**'

      - name: Install fonts (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω TNR –∏–ª–∏ –¥—Ä—É–≥–æ–π)
        run: sudo apt-get update && sudo apt-get install -y fonts-freefont-ttf

      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v2
        with:
          root_file: main.tex
          working_directory: tex
          latexmk_use_xelatex: true
          args: -f

      - name: ls dirs
        run: |
          sudo apt install tree
          tree

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: pdf
          path: tex/target/main.pdf

  code-tests:
    if: ${{ github.event_name == 'push' || github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    name: Run code tests
    # –∑–∞–ø—É—Å—Ç–∏–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–æ —á—Ç–æ-—Ç–æ –≤ code/
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check for code/ changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            code:
              - 'code/**'

      - name: Set up Python
        if: steps.changes.outputs.code == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        if: steps.changes.outputs.code == 'true'
        run: |
          pip install -r code/requirements.txt

      - name: üîÅ Run analyzer on all examples
        run: |
          tree
          for file in code/examples/*.yaml; do
            echo "üîç Running analyzer on $file"
            python code/analyze_postgres_files.py < "$file"
            echo
          done
